#!/bin/bash

# Color definitions
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
CYAN="\e[36m"
NC="\e[0m" # No Color

# Log file
LOGFILE=~/emuinabox_install.log
exec > >(tee -i "$LOGFILE")
exec 2>&1

# ASCII Art Function
function show_ascii_art {
    echo -e "${BLUE}"
    echo "___________            __________              "
    echo "\_   _____/ _____  __ _\______   \ _______  ___"
    echo " |    __)_ /     \|  |  \    |  _//  _ \  \/  /"
    echo " |        \  Y Y  \  |  /    |   (  <_> >    < "
    echo "/_______  /__|_|  /____/|______  /\____/__/\_ \\"
    echo "        \/      \/             \/            \/ "
    echo -e "${NC}"
}

# Progress spinner function
function spinner {
    local pid=$!
    local delay=0.1
    local spinstr='|/-\\'
    while kill -0 $pid 2>/dev/null; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

# Package installation function with colored output
function install_package {
    echo -e "${YELLOW}Installing $1...${NC}"
    if apt-get install -y "$1" &>/dev/null; then
        echo -e "${GREEN}Installed $1 successfully${NC}"
    else
        echo -e "${RED}Failed to install $1${NC}"
        exit 1
    fi
}

# Start of the installation screen
function installation_notice {
    show_ascii_art
    echo -e "${BLUE}--------------------------------------------------${NC}"
    echo -e "${CYAN}      Welcome to the EmuBox Installation!${NC}"
    echo -e "${BLUE}--------------------------------------------------${NC}"
    echo -e "${YELLOW}>> Installing essential packages...${NC}"
    echo -e "${YELLOW}>> Please wait while we set everything up!${NC}"
    echo -e "${BLUE}--------------------------------------------------${NC}"
}

# Start the script
rm -f ~/x

# Update package repository
echo -e "${YELLOW}Updating package repository...${NC}"
apt-get update &>/dev/null

# Install necessary packages
packages=(
    x11-repo
    pulseaudio
    xwayland
    wget
    tsu
    root-repo
    patchelf
    p7zip
    xorg-xrandr
    ncurses-utils
    hashdeep
    termux-x11-nightly
)

# Install packages
for pkg in "${packages[@]}"; do
    install_package "$pkg"
done

# Wait for storage access
echo -n -e "${YELLOW}Setting up storage...${NC}"
termux-setup-storage & spinner
sleep 4

while [ ! -d ~/storage/shared ]; do
    echo -e "${RED}Waiting for storage access...${NC}"
    sleep 3
done
echo -e "${GREEN}Storage setup complete${NC}"

# Continue with the rest of your script...

echo -e "${CYAN}EmuBox installation complete!${NC}"
echo -e "${BLUE}--------------------------------------------------${NC}"
echo -e "${GREEN}You can now start using EmuBox on your Termux setup!${NC}"
echo -e "${BLUE}--------------------------------------------------${NC}"
