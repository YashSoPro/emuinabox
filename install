#!/bin/bash

# Function to check if a command exists
command_exists () {
    type "$1" &> /dev/null ;
}

# Function to install a package if it's not already installed
install_if_not_exists () {
    if ! command_exists $1; then
        echo "Installing $1..."
        pkg install $1 -y
    fi
}

echo "Setting up EmuInABox environment..."

# Ensure required packages are installed
install_if_not_exists wget
install_if_not_exists proot
install_if_not_exists tar

# Set up storage access
termux-setup-storage

# Wait for storage permissions
while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Waiting for storage permission..."
    fi
    sleep 3
done

echo "Storage permission granted."

# Update and upgrade packages
echo "Updating and upgrading packages..."
apt update && apt upgrade -y

# Download and install EmuInABox
echo "Downloading EmuInABox..."
wget https://github.com/Ilya114/Box64Droid/releases/download/2.3.4/Box64Droid-2.3.4-aarch64.tar.gz -O emuinabox.tar.gz

echo "Extracting EmuInABox..."
tar -xzvf emuinabox.tar.gz -C $HOME

echo "Setting up EmuInABox..."
chmod +x $HOME/Box64Droid/box64droid

# Create emuinabox script
cat > $PREFIX/bin/emuinabox << EOL
#!/bin/bash
$HOME/Box64Droid/box64droid
EOL

chmod +x $PREFIX/bin/emuinabox

# Update PATH
echo 'export PATH=$PATH:$PREFIX/bin' >> ~/.bashrc
source ~/.bashrc

echo "Setup complete!"
echo "To start EmuInABox, simply type \"emuinabox\""

# Print debug information
echo "Debug Information:"
echo "PATH: $PATH"
echo "emuinabox location:"
ls -l $PREFIX/bin/emuinabox
echo "Box64Droid script location:"
ls -l $HOME/Box64Droid/box64droid
