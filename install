#!/bin/bash

# Clear previous data
rm ~/x

# ASCII art
echo "___________            __________              "
echo "\_   _____/ _____  __ _\______   \ _______  ___"
echo " |    __)_ /     \|  |  \    |  _//  _ \  \/  /"
echo " |        \  Y Y  \  |  /    |   (  <_> >    < "
echo "/_______  /__|_|  /____/|______  /\____/__/\_ \\"
echo "        \/      \/             \/             \/ "

# Setup termux storage
termux-setup-storage & sleep 4

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Storage permission denied"
    fi
    sleep 3
done

# Install required packages
echo "Installing required packages..."
pkg install termux-am -y
pkg install x11-repo -y
pkg install pulseaudio -y
pkg install wget -y
pkg install tsu -y
pkg install root-repo -y
pkg install patchelf -y
pkg install p7zip -y
pkg install ncurses-utils -y
pkg install hashdeep -y

# Remove previous glibc if it exists
if [ -e $PREFIX/glibc ]; then
    echo -n "Removing previous glibc. Continue? (Y/n) "
    read i
    if [ "$i" = "Y" ] || [ "$i" = "y" ]; then
        rm -rf $PREFIX/glibc
    else
        return 1
    fi
fi

# Select installation type
INSTALL_WOW64=0

echo "Select an option"
echo "1) Install previous emuinabox with box86"
echo "2) Install new emuinabox wow64 version"
echo ""
echo -n "Selected number: "
read i
case "$i" in
1)
    INSTALL_WOW64=0
;;
2)
    INSTALL_WOW64=1
;;
*)
    return 1
;;
esac

# Install emuinabox
echo "Installing emuinabox..."

# Create necessary directories
mkdir -p $PREFIX/glibc/opt/package-manager/installed

# Set private token and project ID
if [ "$INSTALL_WOW64" = "1" ]; then
    echo "PRIVATE_TOKEN=your_private_token" > $PREFIX/glibc/opt/package-manager/token
    echo "PROJECT_ID=your_project_id" >> $PREFIX/glibc/opt/package-manager/token
else
    echo "PRIVATE_TOKEN=your_private_token" > $PREFIX/glibc/opt/package-manager/token
    echo "PROJECT_ID=your_project_id" >> $PREFIX/glibc/opt/package-manager/token
fi

# Load token and project ID
. $PREFIX/glibc/opt/package-manager/token

# Download the package manager
if [ "$INSTALL_WOW64" = "1" ]; then
    wget https://raw.githubusercontent.com/YashSoPro/emuinabox_packages/main/package-manager -O "$PREFIX/glibc/opt/package-manager/package-manager"
else
    wget https://raw.githubusercontent.com/YashSoPro/emuinabox_packages/main/package-manager -O "$PREFIX/glibc/opt/package-manager/package-manager"
fi

# Execute package manager
. $PREFIX/glibc/opt/package-manager/package-manager

# Create a symlink for emuinabox
ln -sf $PREFIX/glibc/opt/scripts/emuinabox $PREFIX/bin/emuinabox
echo "To start - type \"emuinabox\""
