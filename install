#!/bin/bash

# Clear previous data
rm ~/x

# Install termux-am
echo "Installing termux-am..."
pkg install termux-am -y

# Set up storage
termux-setup-storage & sleep 4

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Storage permission denied"
    fi
    sleep 3
done

# Clean and install all required dependencies
echo "Installing termux packages..."
apt-get clean
apt-get update >/dev/null
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null

# List of required packages
REQUIRED_PACKAGES=(
    x11-repo
    pulseaudio
    xwayland
    wget
    tsu
    root-repo
    patchelf
    p7zip
    xorg-xrandr
    ncurses-utils
    hashdeep
    termux-x11-nightly
)

# Install each required package
for pkg in "${REQUIRED_PACKAGES[@]}"; do
    pkg install "$pkg" -y >/dev/null
done

# Remove previous glibc if it exists
if [ -e $PREFIX/glibc ]; then
    echo -n "Removing previous glibc. Continue? (Y/n) "
    read i
    if [[ "$i" != "Y" && "$i" != "y" ]]; then
        exit 1
    fi
    rm -rf $PREFIX/glibc
fi

# Select installation type
INSTALL_WOW64=0
echo "Select an option:"
echo "1) Install previous emuinabox with box86"
echo "2) Install new emuinabox wow64 version"
echo ""
echo -n "Selected number: "
read i
case "$i" in
    1) INSTALL_WOW64=0 ;;
    2) INSTALL_WOW64=1 ;;
    *) exit 1 ;;
esac

echo "Installing emuinabox..."

# Create necessary directories
mkdir -p $PREFIX/glibc/opt/package-manager/installed

# Set private token and project ID based on selection
if [ "$INSTALL_WOW64" -eq 1 ]; then
    echo "PRIVATE_TOKEN=glpat-h5r7HjKoPKZPxmfg79xs" >$PREFIX/glibc/opt/package-manager/token
    echo "PROJECT_ID=54240888" >>$PREFIX/glibc/opt/package-manager/token
else
    echo "PRIVATE_TOKEN=glpat-Xs4HfrCkMpbedkPycqzP" >$PREFIX/glibc/opt/package-manager/token
    echo "PROJECT_ID=52465323" >>$PREFIX/glibc/opt/package-manager/token
fi

# Load token and project ID
. $PREFIX/glibc/opt/package-manager/token

# Download the package manager script
if [ "$INSTALL_WOW64" -eq 1 ]; then
    curl -s https://raw.githubusercontent.com/YashSoPro/emuinabox/main/package-manager -o "$PREFIX/glibc/opt/package-manager/package-manager"
else
    wget --quiet --show-progress --header "PRIVATE-TOKEN: $PRIVATE_TOKEN" "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/package-manager/raw?ref=main" -O "$PREFIX/glibc/opt/package-manager/package-manager"
fi

# Execute the package manager script
. $PREFIX/glibc/opt/package-manager/package-manager

# Sync all dependencies
sync-all

# Install wine based on selection
if [ "$INSTALL_WOW64" -eq 1 ]; then
    sync-package wine-9.3-vanilla-wow64
else
    sync-package wine-ge-custom-8-25
fi

# Create a symlink for emuinabox
ln -sf $PREFIX/glibc/opt/scripts/emuinabox $PREFIX/bin/emuinabox
echo "To start - type \"emuinabox\""
