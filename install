#!/bin/bash

# Function to check and create directory
create_dir_if_not_exists() {
    if [ ! -d "$1" ]; then
        mkdir -p "$1"
        echo "Created directory: $1"
    fi
}

# Create required directories
create_dir_if_not_exists "$PREFIX/glibc/opt/scripts"
create_dir_if_not_exists "$PREFIX/glibc/opt/package-manager/installed"
create_dir_if_not_exists "$PREFIX/glibc/opt/package-manager"

# Install required packages
echo "Installing required packages..."
pkg install termux-am -y

# Setup storage
termux-setup-storage & sleep 4

# Wait for storage permission
while true; do
    if [ -d ~/storage/shared ]; then
        echo "Storage permission granted."
        break
    else
        echo "Waiting for storage permission..."
    fi
    sleep 3
done

# Update package lists
apt-get clean
apt-get update >/dev/null

# Install required packages
required_packages=(
    x11-repo
    pulseaudio
    xwayland
    wget
    tsu
    root-repo
    patchelf
    p7zip
    ncurses-utils
    hashdeep
    termux-x11-nightly
)

for pkg in "${required_packages[@]}"; do
    if ! dpkg -l | grep -q "$pkg"; then
        echo "Installing $pkg..."
        pkg install "$pkg" -y || { echo "Failed to install $pkg"; exit 1; }
    fi
done

# Remove previous glibc if it exists
if [ -e $PREFIX/glibc ]; then
    echo -n "Removing previous glibc. Continue? (Y/n) "
    read i
    if [[ "$i" != "Y" && "$i" != "y" ]]; then
        echo "Skipping glibc removal."
    else
        rm -rf $PREFIX/glibc
        echo "Removed previous glibc."
    fi
fi

# Prompt user for installation option
echo "Select installation option:"
echo "1) Install previous mobox with box86"
echo "2) Install new mobox wow64 version"
echo -n "Selected number: "
read i

INSTALL_WOW64=0
if [ "$i" == "2" ]; then
    INSTALL_WOW64=1
fi

# Use tokens based on installation option
if [ "$INSTALL_WOW64" -eq 1 ]; then
    echo "PRIVATE_TOKEN=glpat-h5r7HjKoPKZPxmfg79xs" > "$PREFIX/glibc/opt/package-manager/token"
    echo "PROJECT_ID=54240888" >> "$PREFIX/glibc/opt/package-manager/token"
else
    echo "PRIVATE_TOKEN=glpat-Xs4HfrCkMpbedkPycqzP" > "$PREFIX/glibc/opt/package-manager/token"
    echo "PROJECT_ID=52465323" >> "$PREFIX/glibc/opt/package-manager/token"
fi

# Create symlink for emuinabox
if [ ! -L "$PREFIX/bin/emuinabox" ]; then
    ln -sf "$PREFIX/glibc/opt/scripts/emuinabox" "$PREFIX/bin/emuinabox"
fi

echo "Setup complete. To start, type 'emuinabox'."
